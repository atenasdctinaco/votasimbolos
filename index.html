<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√≠mbolos Naturales | Municipio Tinaco</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --azul-tinaco: #1a2980; --rojo-tinaco: #ff0000; --blanco: #ffffff;
            --glass: rgba(255, 255, 255, 0.12);
        }
        
        body {
            margin: 0; font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--azul-tinaco) 0%, #26d0ce 100%);
            background-attachment: fixed; color: #fff; overflow-x: hidden;
        }

        .glass-card {
            background: var(--glass); backdrop-filter: blur(25px);
            border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .screen { display: none; min-height: 100vh; padding: 40px 20px; box-sizing: border-box; }
        .active { display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.6s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- FORMULARIO --- */
        .form-group { width: 100%; margin-bottom: 15px; text-align: left; }
        .row { display: flex; gap: 15px; width: 100%; }
        .col-short { flex: 0 0 80px; }
        .col-wide { flex: 1; }

        input, select {
            width: 100%; padding: 12px; margin-top: 5px; border-radius: 12px; border: none; 
            font-family: 'Outfit'; box-sizing: border-box; background: white; color: #333;
        }

        .phone-input { display: flex; gap: 5px; }
        .phone-input select { width: 90px; }

        /* --- IM√ÅGENES --- */
        .img-container {
            width: 100%; height: 200px; background: rgba(0,0,0,0.3);
            border-radius: 20px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .zoom-btn {
            position: absolute; top: 10px; right: 10px; background: var(--rojo-tinaco);
            color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; z-index: 10;
        }

        .btn-action {
            background: var(--rojo-tinaco); color: white; border: none; padding: 15px 25px;
            border-radius: 20px; cursor: pointer; font-weight: 700; transition: 0.3s; 
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; font-size: 0.9rem;
        }
        .btn-action:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .btn-action:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }

        /* --- FOOTER --- */
        footer {
            text-align: center; padding: 50px 20px; font-size: 0.9rem; 
            background: rgba(0,0,0,0.3); margin-top: 50px;
        }
        .footer-logo { width: 80px; height: 80px; margin-bottom: 15px; border-radius: 50%; border: 2px solid white; }
        footer a { color: #ffd700; text-decoration: none; font-weight: 700; }
        footer p { max-width: 800px; margin: 10px auto; line-height: 1.6; }

        .grid-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; padding-bottom: 50px;}
        
        /* Tooltip de retorno */
        .return-hint { font-size: 0.8rem; color: #ffd700; margin-top: 10px; display: none; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

<section id="screen-intro" class="screen active">
    <div class="glass-card" style="max-width: 750px; padding: 40px; text-align: center;">
        <h2 style="letter-spacing: 3px; font-weight: 300;">ALCALD√çA DE TINACO</h2>
        <h1 style="font-size: 2.5rem; margin: 10px 0;">Identidad Natural</h1>
        <p>Votaci√≥n ciudadana para la elecci√≥n de nuestros S√≠mbolos Naturales.</p>
        <br>
        <button class="btn-action" onclick="nextScreen('screen-form')">EMPEZAR VOTACI√ìN</button>
    </div>
</section>

<section id="screen-form" class="screen">
    <div class="glass-card" style="max-width: 550px; padding: 35px; width: 90%;">
        <h2 style="text-align: center; margin-bottom: 20px;">Datos del Votante</h2>
        <div class="form-group"><label>C√©dula de Identidad *</label><input type="number" id="v-ci" oninput="saveProgress()"></div>
        <div class="form-group"><label>Nombre Completo *</label><input type="text" id="v-nombre" oninput="saveProgress()"></div>
        <div class="row">
            <div class="col-short"><label>Edad *</label><input type="number" id="v-edad" oninput="saveProgress()"></div>
            <div class="col-wide"><label>G√©nero *</label><select id="v-genero" onchange="saveProgress()"><option value="F">Femenino</option><option value="M">Masculino</option><option value="O">Otro</option></select></div>
        </div>
        <div class="form-group"><label>Sector de Residencia *</label><input type="text" id="v-sector" oninput="saveProgress()"></div>
        <div class="form-group">
            <label>WhatsApp (Opcional)</label>
            <div class="phone-input">
                <select id="v-country"><option value="+58" selected>üáªüá™ +58</option></select>
                <input type="tel" id="v-ws" oninput="saveProgress()">
            </div>
        </div>
        <button class="btn-action" onclick="validateForm()">CONTINUAR</button>
    </div>
</section>

<section id="screen-selector" class="screen">
    <h2 style="margin-bottom:30px; text-align: center;">Categor√≠as de Votaci√≥n</h2>
    <div class="grid-cards" style="max-width: 800px;">
        <div class="glass-card" style="padding: 40px; text-align: center; cursor: pointer;" onclick="renderVotacion('aves')">
            <i class="fas fa-feather-alt fa-4x"></i><h3>AVES</h3>
            <div id="check-ave" style="display:none; color: #00ff00; font-weight: bold;">‚úÖ SELECCIONADO</div>
        </div>
        <div class="glass-card" style="padding: 40px; text-align: center; cursor: pointer;" onclick="renderVotacion('flores')">
            <i class="fas fa-seedling fa-4x"></i><h3>FLORES</h3>
            <div id="check-flor" style="display:none; color: #00ff00; font-weight: bold;">‚úÖ SELECCIONADO</div>
        </div>
    </div>
</section>

<section id="screen-voting" class="screen">
    <h2 id="vote-title" style="text-align: center;"></h2>
    <div class="grid-cards" id="container-voting"></div>
</section>

<section id="screen-final" class="screen">
    <div class="glass-card" style="max-width: 550px; padding: 40px; text-align: center; width: 90%;">
        <h2 style="margin-bottom: 20px;">Confirmar Participaci√≥n</h2>
        <p>1. Suscr√≠bete para validar tu voto:</p>
        <div style="max-width: 250px; margin: auto;">
            <a href="https://www.youtube.com/@epistecnologia?sub_confirmation=1" target="_blank" class="btn-action" style="background: #ff0000; text-decoration: none;" onclick="unlockBtn()">
                <i class="fab fa-youtube"></i> SUSCRIBIRSE
            </a>
        </div>
        <p id="return-text" class="return-hint"><i class="fas fa-arrow-left"></i> <b>¬°Regresa a esta pesta√±a para finalizar!</b></p>
        <br>
        <p>2. Presiona el bot√≥n verde al regresar:</p>
        <button id="finish-v" class="btn-action" disabled onclick="enviarASupabase()">
            <i class="fas fa-check-circle"></i> FINALIZAR MI VOTO
        </button>
    </div>
</section>

<section id="screen-results" class="screen">
    <div class="glass-card" style="width: 95%; max-width: 1000px; padding: 40px; text-align: center;">
        <h1>Escrutinio Real</h1>
        <div class="row" style="flex-wrap: wrap; justify-content: center; gap: 40px;">
            <div style="width: 320px;"><canvas id="chartAves"></canvas></div>
            <div style="width: 320px;"><canvas id="chartFlores"></canvas></div>
        </div>
        <br><button class="btn-action" style="max-width: 200px; margin: auto;" onclick="resetVotacion()">INICIO</button>
    </div>
</section>

<footer>
    <img src="https://i.ibb.co/hFRyKrxY/logo-epist-v3-1x1-c.png" class="footer-logo" alt="Logo">
    <p><b>ALCALD√çA DEL MUNICIPIO TINACO</b></p>
    <p>Sistema desarrollado por <a href="https://epistecnologia.com/" target="_blank">Epistecnolog√≠a</a>.</p>
    <p>Plataforma desarrollada por el tinaquero <a href="https://epistecnologia.com/@henry" target="_blank">Henry Adolfo M√°rquez Mercado</a>.</p>
</footer>

<div id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center;" onclick="this.style.display='none'">
    <img id="modal-img" src="" style="max-width: 90%; max-height: 90%; border-radius: 10px;">
</div>

<script>
    // --- SUPABASE CONFIG ---
    const S_URL = "https://rccwtttftdgpbzkromux.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjY3d0dHRmdGRncGJ6a3JvbXV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzk0MDQsImV4cCI6MjA4NzYxNTQwNH0.W1qs1oF3IbVM7Uph2wKKIJs-W09uNwwhJ2TFFpdT3n4"; 
    const _supabase = supabase.createClient(S_URL, S_KEY);

    // --- DATA ---
    const dataAves = [
        {nombre: 'Carpintero', img: 'https://i.ibb.co/kg3YG0dP/large.jpg', desc: 'Ingeniero forestal que controla plagas.'},
        {nombre: 'Sangre toro', img: 'https://i.ibb.co/NnGg1Q86/900.jpg', desc: 'S√≠mbolo de vitalidad y pasi√≥n llanera.'},
        {nombre: 'CristoFue', img: 'https://i.ibb.co/nNLYqT3M/900.jpg', desc: 'Vigilante adaptable de nuestros patios.'},
        {nombre: 'El Gaban', img: 'https://i.ibb.co/HTL8cxgG/43dac00274fc4fe2e1f4ced2ce7f8459.jpg', desc: 'La m√°xima elegancia de los esteros.'},
        {nombre: 'Alcaravan', img: 'https://inaturalist-open-data.s3.amazonaws.com/photos/135057906/large.jpeg', desc: 'Guardi√°n nocturno de la sabana.'}
    ];

    const dataFlores = [
        {nombre: 'Lirio Sabanero', img: 'https://i.ibb.co/Zz4Rwj1j/Lirio-Sabanero.jpg', desc: 'Resiliencia pura tras la lluvia.'},
        {nombre: 'Ruellia', img: 'https://i.ibb.co/Sw52WZbc/960px-Ruellia-simplex-02.jpg', desc: 'Tradici√≥n en los jardines locales.'},
        {nombre: 'Bototo', img: 'https://i.ibb.co/KzzmNF9b/Bototo.jpg', desc: 'El oro del llano en cada p√©talo.'},
        {nombre: 'Nazareno', img: 'https://i.ibb.co/wmfqWGG/shutterstock-1056956174.jpg', desc: 'Espiritualidad silvestre p√∫rpura.'},
        {nombre: 'Cimbapotro', img: 'https://i.ibb.co/DDxwXZbB/floripondio.jpg', desc: 'Especie clave de nuestro ecosistema.'},
        {nombre: 'Clavelina', img: 'https://i.ibb.co/KpP5FFb3/clavelina-rebecca-niver-z0txuuculfq-unsplash-946793cd-1200x630.jpg', desc: 'Orgullo ornamental tinaquero.'}
    ];

    let userVoto = JSON.parse(localStorage.getItem('userVoto')) || { ci: '', nombre: '', edad: '', genero: '', sector: '', ws: '', ave: null, flor: null };

    // Recuperar estado al cargar
    window.onload = () => {
        if(userVoto.ci) {
            document.getElementById('v-ci').value = userVoto.ci;
            document.getElementById('v-nombre').value = userVoto.nombre;
            document.getElementById('v-edad').value = userVoto.edad;
            document.getElementById('v-genero').value = userVoto.genero;
            document.getElementById('v-sector').value = userVoto.sector;
            document.getElementById('v-ws').value = userVoto.ws.replace('+58', '');
        }
        if(userVoto.ave) document.getElementById('check-ave').style.display='block';
        if(userVoto.flor) document.getElementById('check-flor').style.display='block';
    };

    function saveProgress() {
        userVoto.ci = document.getElementById('v-ci').value;
        userVoto.nombre = document.getElementById('v-nombre').value;
        userVoto.edad = document.getElementById('v-edad').value;
        userVoto.genero = document.getElementById('v-genero').value;
        userVoto.sector = document.getElementById('v-sector').value;
        userVoto.ws = document.getElementById('v-country').value + document.getElementById('v-ws').value;
        localStorage.setItem('userVoto', JSON.stringify(userVoto));
    }

    function nextScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }

    function validateForm() {
        saveProgress();
        if(!userVoto.ci || !userVoto.nombre || !userVoto.sector || !userVoto.edad) {
            return alert("Por favor, complete todos los campos obligatorios.");
        }
        nextScreen('screen-selector');
    }

    function renderVotacion(tipo) {
        const container = document.getElementById('container-voting');
        const lista = tipo === 'aves' ? dataAves : dataFlores;
        document.getElementById('vote-title').innerText = tipo === 'aves' ? 'ELIJA EL AVE' : 'ELIJA LA FLOR';
        container.innerHTML = '';
        lista.forEach(item => {
            const card = document.createElement('div');
            card.className = "glass-card"; card.style.padding = "20px";
            card.innerHTML = `
                <div class="img-container"><img src="${item.img}"><button class="zoom-btn" onclick="viewImg('${item.img}')"><i class="fas fa-expand"></i></button></div>
                <h3 style="color:#ffd700; margin:15px 0 5px 0;">${item.nombre}</h3><p style="font-size:0.8rem; height:45px;">${item.desc}</p>
                <button class="btn-action" onclick="setVoto('${tipo}', '${item.nombre}')">SELECCIONAR</button>`;
            container.appendChild(card);
        });
        nextScreen('screen-voting');
    }

    function setVoto(tipo, nombre) {
        if(tipo === 'aves') { userVoto.ave = nombre; document.getElementById('check-ave').style.display='block'; }
        else { userVoto.flor = nombre; document.getElementById('check-flor').style.display='block'; }
        saveProgress();
        nextScreen((userVoto.ave && userVoto.flor) ? 'screen-final' : 'screen-selector');
    }

    function unlockBtn() { 
        document.getElementById('return-text').style.display = 'block';
        const b = document.getElementById('finish-v');
        setTimeout(() => { 
            b.disabled = false; 
            b.style.background = "#27ae60"; 
            b.innerHTML = '<i class="fas fa-check-circle"></i> ¬°LISTO! FINALIZAR VOTO';
        }, 3000); 
    }

    async function enviarASupabase() {
        const btn = document.getElementById('finish-v');
        btn.disabled = true; btn.innerText = "REGISTRANDO...";

        const { error } = await _supabase.from('votos').insert([{
            cedula: userVoto.ci, nombre_completo: userVoto.nombre, edad: parseInt(userVoto.edad),
            genero: userVoto.genero, sector: userVoto.sector, whatsapp: userVoto.ws,
            voto_ave: userVoto.ave, voto_flor: userVoto.flor
        }]);

        if (error) {
            if(error.code === '23505') alert("Esta c√©dula ya registr√≥ su voto.");
            else alert("Error: " + error.message);
            btn.disabled = false; btn.innerText = "FINALIZAR MI VOTO";
        } else {
            localStorage.removeItem('userVoto');
            nextScreen('screen-results');
            mostrarEstadisticas();
        }
    }

    function resetVotacion() {
        localStorage.removeItem('userVoto');
        location.reload();
    }

    async function mostrarEstadisticas() {
        const { data } = await _supabase.from('votos').select('voto_ave, voto_flor');
        const counts = (arr, key) => arr.reduce((a, c) => (a[c[key]] = (a[c[key]] || 0) + 1, a), {});
        const avesMap = counts(data || [], 'voto_ave');
        const floresMap = counts(data || [], 'voto_flor');

        new Chart(document.getElementById('chartAves'), {
            type: 'doughnut',
            data: { labels: Object.keys(avesMap), datasets: [{ data: Object.values(avesMap), backgroundColor: ['#1a2980','#ff0000','#ffd700','#27ae60','#8e44ad'] }] },
            options: { plugins: { title: { display: true, text: 'Escrutinio Aves', color: '#fff' } } }
        });

        new Chart(document.getElementById('chartFlores'), {
            type: 'bar',
            data: { labels: Object.keys(floresMap), datasets: [{ label: 'Votos', data: Object.values(floresMap), backgroundColor: '#ffd700' }] },
            options: { plugins: { legend: { display: false }, title: { display: true, text: 'Escrutinio Flores', color: '#fff' } }, scales: { y: { ticks: { color: '#fff' } }, x: { ticks: { color: '#fff' } } } }
        });
    }

    function viewImg(url) { 
        document.getElementById('modal-img').src = url; 
        document.getElementById('image-modal').style.display = 'flex'; 
    }
</script>
</body>
</html>
